<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>找醫生 - 智慧醫療導航</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #map { height: 450px; }
        body { padding-top: 2rem; padding-bottom: 2rem; } 
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4 text-center">找醫生 - 智慧醫療導航</h1>
        <div class="row g-3 align-items-end justify-content-center mb-4">
            
            <div class="col-md-3">
                <label for="city-select" class="form-label">選擇縣市:</label>
                <select id="city-select" class="form-select">
                    <option value="">載入中... </option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="district-select" class="form-label">鄉鎮市區:</label>
                <select id="district-select" class="form-select">
                    <option value="">請先選擇縣市</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="dept-select" class="form-label">選擇科別:</label>
                <select id="dept-select" class="form-select">
                    <option value="">載入中... </option>
                </select>
            </div>

            <div class="col-md-auto">
                <button onclick="searchClinics()" class="btn btn-primary w-100">搜尋</button>
            </div>
            
        </div>
        <hr>
        <div id="map"></div>
        <ul id="clinic-list" class="list-group mt-3 mb-5"></ul>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // 初始化地圖
        const map = L.map('map').setView([25.033, 121.565], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        let markerLayer = L.layerGroup().addTo(map);

        let districtsData = {};

        document.addEventListener('DOMContentLoaded', function() {
            loadDepartments();
            loadDistricts();
        });

        const citySelect = document.getElementById('city-select');
        const districtSelect = document.getElementById('district-select');
        const deptSelect = document.getElementById('dept-select');

        citySelect.addEventListener('change', function() {
            updateDistrictOptions(this.value);
        });


        function loadDepartments(){
            fetch('http://127.0.0.1:5001/api/departments')
                .then(response => response.json()) 
                .then(departments => {
                    deptSelect.innerHTML = ''; 
                    departments.forEach(department => {
                        const option = document.createElement('option');
                        option.value = department; // 選項的 value (送給後端的值)
                        option.textContent = department; // 選項顯示的文字
                        deptSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('無法載入科別列表:', error);
                    deptSelect.innerHTML = '<option value="">載入科別失敗</option>';
                });
        }
        function loadDistricts() {
            fetch('http://127.0.0.1:5001/api/districts')
                .then(response => response.json())
                .then(data => {
                    districtsData = data;
                    const cities = Object.keys(districtsData);
                    
                    citySelect.innerHTML = '<option value="">請選擇縣市</option>';
                    cities.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city;
                        option.textContent = city;
                        citySelect.appendChild(option);
                    });
                    
                    if (cities.length > 0) {
                        citySelect.value = cities[0];
                        updateDistrictOptions(cities[0]);
                    }
                })
                .catch(error => {
                    console.error('無法載入地區列表:', error);
                    citySelect.innerHTML = '<option value="">載入失敗</option>';
                });
        }

        function updateDistrictOptions(selectedCity) {
            const districts = districtsData[selectedCity] || [];
            districtSelect.innerHTML = '<option value="">全部</option>';
            districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                districtSelect.appendChild(option);
            });
        }

        
        async function searchClinics() {
            const city = citySelect.value;
            const district = districtSelect.value;
            const department = deptSelect.value; 
            const listElement = document.getElementById('clinic-list');
            
            listElement.innerHTML = '';
            markerLayer.clearLayers();

            const response = await fetch(`http://127.0.0.1:5001/search?city=${city}&district=${district}&department=${department}`);
            const clinics = await response.json();
            
            if (clinics.length === 0) {
                const li = document.createElement('li');
                li.className = 'list-group-item text-muted';
                li.textContent = '找不到符合條件的醫療院所。';
                listElement.appendChild(li);
                return;
            }

            clinics.forEach(clinic => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                const phone = clinic.電話 ? `(${clinic.電話})` : '';
                li.textContent = `${clinic.機構名稱} - ${clinic.地址} ${phone}`;
                listElement.appendChild(li);

                if (clinic.latitude && clinic.longitude) {
                    const marker = L.marker([clinic.latitude, clinic.longitude]).addTo(markerLayer);
                    marker.bindPopup(`<b>${clinic.機構名稱}</b><br>${clinic.地址}`);
                }
            });

            if (clinics.length > 0) {
                map.flyTo([clinics[0].latitude, clinics[0].longitude], 15);
            }
        }
    </script>
</body>
</html>