<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>找醫生 - 智慧醫療導航</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #map { height: 450px; }
        body { padding-top: 2rem; padding-bottom: 2rem; } 
        /* 【新增】讓列表項目在滑鼠移過時，顯示為可點擊的手指圖示 */
        .list-group-item:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4 text-center">找醫生 - 智慧醫療導航</h1>
        <div class="row g-3 align-items-end justify-content-center mb-4">
            
            <div class="col-md-3">
                <label for="city-select" class="form-label">選擇縣市:</label>
                <select id="city-select" class="form-select">
                    <option value="">載入中... </option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="district-select" class="form-label">鄉鎮市區:</label>
                <select id="district-select" class="form-select">
                    <option value="">載入中...</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="dept-select" class="form-label">選擇科別:</label>
                <select id="dept-select" class="form-select">
                    <option value="">載入中... </option>
                </select>
            </div>

            <div class="col-md-auto">
                <button onclick="searchClinics()" class="btn btn-primary w-100">搜尋</button>
            </div>
            
        </div>
        <hr>
        <div id="map"></div>
        <ul id="clinic-list" class="list-group mt-3 mb-5"></ul>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // 初始化地圖
        const map = L.map('map').setView([25.033, 121.565], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        let markerLayer = L.featureGroup().addTo(map);

        let districtsData = {};
        let markers = [];

        document.addEventListener('DOMContentLoaded', function() {
            loadDepartments();
            loadDistricts();
        });

        const citySelect = document.getElementById('city-select');
        const districtSelect = document.getElementById('district-select');
        const deptSelect = document.getElementById('dept-select');

        citySelect.addEventListener('change', function() {
            updateDistrictOptions(this.value);
        });


        function loadDepartments(){
            fetch('http://127.0.0.1:5001/api/departments')
                .then(response => response.json()) 
                .then(departments => {
                    deptSelect.innerHTML = ''; 
                    departments.forEach(department => {
                        const option = document.createElement('option');
                        option.value = department; 
                        option.textContent = department; 
                        deptSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('無法載入科別列表:', error);
                    deptSelect.innerHTML = '<option value="">載入科別失敗</option>';
                });
        }
        function loadDistricts() {
            fetch('http://127.0.0.1:5001/api/districts')
                .then(response => response.json())
                .then(data => {
                    districtsData = data;
                    const cities = Object.keys(districtsData);
                    
                    citySelect.innerHTML = '<option value="">請選擇縣市</option>';
                    cities.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city;
                        option.textContent = city;
                        citySelect.appendChild(option);
                    });
                    
                    if (cities.length > 0) {
                        citySelect.value = cities[0];
                        updateDistrictOptions(cities[0]);
                    }
                })
                .catch(error => {
                    console.error('無法載入地區列表:', error);
                    citySelect.innerHTML = '<option value="">載入失敗</option>';
                });
        }

        function updateDistrictOptions(selectedCity) {
            const districts = districtsData[selectedCity] || [];
            districtSelect.innerHTML = '<option value="">全部</option>';
            districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                districtSelect.appendChild(option);
            });
        }

        
        async function searchClinics() {
            const city = citySelect.value;
            const district = districtSelect.value;
            const department = deptSelect.value; 
            const listElement = document.getElementById('clinic-list');
            
            listElement.innerHTML = '';
            markerLayer.clearLayers();
            markers = []; // 【新增】每次搜尋前，清空標記陣列

            const response = await fetch(`http://127.0.0.1:5001/search?city=${city}&district=${district}&department=${department}`);
            const clinics = await response.json();
            
            if (clinics.length === 0) {
                const li = document.createElement('li');
                li.className = 'list-group-item text-muted';
                li.textContent = '找不到符合條件的醫療院所。';
                listElement.appendChild(li);
                return;
            }

            try{
                clinics.forEach((clinic, index) => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';

                    // 【核心修正】對所有可能不存在的資料進行防禦性檢查
                    const name = clinic.機構名稱;
                    const address = clinic.地址;
                    const phone = clinic.電話;

                    li.textContent = `${name} - ${address} ${phone}`;
                    
                    li.dataset.markerIndex = index;

                    li.addEventListener('click', function() {
                        const markerIndex = this.dataset.markerIndex;
                        const targetMarker = markers[markerIndex];
                        if (targetMarker) {
                            map.flyTo(targetMarker.getLatLng(), 16);
                            targetMarker.openPopup();
                        }
                    });

                    listElement.appendChild(li);

                    if (clinic.latitude && clinic.longitude) {
                        const marker = L.marker([clinic.latitude, clinic.longitude]).addTo(markerLayer);
                        // 【核心修正】在資訊窗中也使用更安全的變數
                        marker.bindPopup(`<b>${name}</b><br>${address}<br>電話: ${phone || '無'}`);
                        markers.push(marker);
                    } else {
                        markers.push(null);
                    }
                });
            }
            catch (e) {
                console.error("在處理診所列表時發生錯誤:", e);
                listElement.innerHTML = '<li class="list-group-item text-danger">處理結果時發生錯誤，請查看主控台。</li>';
            }

            // 【核心修正】移除 setTimeout，直接執行縮放
            const addedMarkersCount = markerLayer.getLayers().length;
            if (addedMarkersCount > 1) {
                map.flyToBounds(markerLayer.getBounds(), { padding: [50, 50] });
            } else if (addedMarkersCount === 1) {
                map.flyTo(markerLayer.getLayers()[0].getLatLng(), 16);
            }
        }
    </script>
</body>
</html>